<style>
    .label_w{width:170px;}
    .un-select{-webkit-appearance: menulist;}
</style>
<div id="content-container">

            <!-- 面包屑header -->
            <div class="wp99">
                <div class="big_box">
                    <div class="btn_box">
                        <!-- <div class="btn_item btn_item_left">保存草稿</div> -->
                        <button class="btn btn_item btn_item_left submit">完成</button>
                        <!-- <button class="btn btn_item btn_item_left submit_next">完成并下一位</button> -->
                        <button class="btn btn_item btn_item_left call_number">呼叫</button>

                        <div class="un_number">{$info.registerInfo.Number}号</div>
                        

                        <!-- <div class="input_box">
                            <input type="text" class="form-control _input" placeholder="请输入编号">
                            <div class="input_btn">跳转</div>
                        </div> -->
                        <button class="btn btn_item btn_item_right next_number">下一位</button>
                        <button class="btn btn_item btn_item_right prev_number">上一位</button>
                        <div class="un_writingdesk"></div>
                    </div>
                    <div class="center_box">
                        <div class="cen_left">
                            <div class="cen_title"> 孩子信息</div>
                            <div class="form_box">
                                <form class="layui-form" action="" id="form">
                                    <div class="form_left">
                                        <input type="hidden" name="id" value="{$info.registerInfo.Id}">

                                        <input type="hidden" name="WritingDesk">

                                        <input type="hidden" name="ChildId"  value="{$info['registerInfo']['ChildId']|default='0'}">

                                        <div class="layui-form-item">
                                            <label class="layui-form-label" style="color:#666">卡号：</label>
                                            <div class="layui-input-block">
                                                <input type="text" name="CardNo" autocomplete="off"
                                                    placeholder="请输入卡号" class="layui-input" value="{$info['registerInfo']['CardNo']|default=''}">
                                                    <i class="fa fa-search i-seach"></i>
                                            </div>
                                        </div>
                                        <div class="layui-form-item">
                                            <label class="layui-form-label" style="color:#666">姓名：</label>
                                            <div class="layui-input-block">
                                                <input type="text" name="Name" autocomplete="off"
                                                    placeholder="请输入姓名" class="layui-input" value="{$info['registerInfo']['child_name']|default=''}">
                                            </div>
                                        </div>
                                        <div class="layui-form-item">
                                            <label class="layui-form-label" style="color:#666">出生日期：</label>
                                            <div class="layui-input-block">
                                                <input type="text" name="BirthDate" autocomplete="off"
                                                    placeholder="请输入出生日期" class="layui-input BirthDate" value="{$info['registerInfo']['BirthDate']|default=''}">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form_right">
                                        <div class="layui-form-item">
                                            <label class="layui-form-label" style="color:#666">家长：</label>
                                            <div class="layui-input-block">
                                                <input type="text" name="ParentName" autocomplete="off"
                                                    placeholder="请输入家长姓名" class="layui-input" value="{$info['registerInfo']['ParentName']|default=''}">
                                            </div>
                                        </div>
                                        <div class="layui-form-item">
                                            <label class="layui-form-label" style="color:#666">电话：</label>
                                            <div class="layui-input-block">
                                                <input type="text" name="Mobile" autocomplete="off"
                                                    placeholder="请输入电话" class="layui-input" value="{$info['registerInfo']['Mobile']|default=''}">
                                            </div>
                                        </div>
                                        <div class="layui-form-item">
                                            <label class="layui-form-label" style="color:#666">性别：</label>
                                            <div class="layui-input-block" lay-filter="Sex">
                                                <select name="Sex">
                                                    <option value="1" {if condition="$info['registerInfo']['Sex'] == 1"} selected {/if}>男</option>
                                                    <option value="2" {if condition="$info['registerInfo']['Sex'] == 2"} selected {/if}>女</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form_bottom">
                                        <div class="layui-form-item layui-form-text">
                                            <label class="layui-form-label" style="color:#666">家庭住址：</label>
                                            <div class="layui-input-block">
                                                <textarea placeholder="请输入家庭住址" class="layui-textarea" name="Address">{$info['registerInfo']['Address']|default=''}</textarea>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="cen_right">
                            <div class="cen_title"> 采集信息</div>
                            <div class="icon_box">
                                <div class="icon_text">头像</div>
                                {empty name="info['head_fingerprint_path']['head.JPG']"}
                                <i class="iconfont icon-xingzhuanggongnengtubiao-" style="font-size: 150px;line-height: 150px;"></i>
                                {else/}
                                <img src="{$info['head_fingerprint_path']['head.JPG']}">
                                {/empty}
                            </div>
                            <div class="icon_box">
                                <div class="icon_text">指纹</div>
                                {empty name="info['head_fingerprint_path']['fingerprint.JPG']"}
                                <i class="iconfont icon-fingerprint__" style="font-size: 100px;line-height: 150px;"></i>
                                {else/}
                                <img src="{$info['head_fingerprint_path']['fingerprint.JPG']}">
                                {/empty}
                            </div>
                        </div>
                    </div>
                    <div class="today_box">
                        <div class="cen_title"> <span>今日接种疫苗</span>
                            <button class="btn btn_item btn_item_right add_vaccination">添加</button>
                        </div>
                        <table class="layui-table" id="test">
                            <thead>
                                <tr>
                                    <th>接种疫苗</th>
                                    <th>剂次</th>
                                    <th>疫苗批号</th>
                                    <th>生产企业</th>
                                    <th>接种部位</th>
                                    <th>接种地址</th>
                                    <th>免费</th>
                                    <th>操作</th>
                                </tr> 
                            </thead>
                            <tbody>
                                {notempty name="info['registerInfoDefilds']"}
                                    {volist name="info['registerInfoDefilds']" id="vo"}
                                        <tr>
                                            <td style="display: none;"><input type="hidden" name="Id" value="{$vo.Id}"></td>
                                            <td>
                                                <select class="layui-input" name="VaccineId">
                                                    <option>请选择</option>
                                                    {volist name="info.vaccines" id="voo"}
                                                    <option value="{$voo.Id}" {if condition="$vo['VaccineId'] == $voo['Id']"} selected {/if}>{$voo.ShortName}</option>
                                                    {/volist}
                                                </select>
                                            </td>
                                            <td>
                                                <input class="layui-input" type="text" name="Times" value="{$vo.Times}">
                                            </td>
                                            <td>
                                                <input class="layui-input" type="text" placeholder="请填写疫苗批号" name="LotNumber" value="{$vo.LotNumber}">
                                            </td>
                                            <td>
                                                <input class="layui-input" type="text" placeholder="请填写疫苗公司" name="Company" value="{$vo.Company}">
                                            </td>
                                            <td>
                                                <input class="layui-input" type="text" placeholder="请填写疫苗地址" name="VaccinationPlace" value="{$vo.VaccinationPlace}">
                                            </td>
                                            <td>
                                                <input class="layui-input" type="text" placeholder="请填写接种部位" name="VaccinationPosition" value="{$vo.VaccinationPosition}">
                                            </td>
                                            <td>
                                                {if condition="$vo['IsFree'] == 1"}
                                                <input type="checkbox" lay-skin="primary" name="IsFree" value="1" checked>
                                                {else}
                                                <input type="checkbox" lay-skin="primary" name="IsFree" value="1">
                                                {/if}
                                            </td>
                                            <td>
                                                <a class="del_vaccination" id="{$vo.Id}">删除</a>
                                            </td>
                                        </tr>
                                    {/volist}
                                {/notempty}

                                
                            </tbody>
                        </table>
                    </div>
                    <div class="today_box">
                        <div class="cen_title"> <span>历史接种疫苗</span> </div>
                        <table class="layui-hide" id="test1"></table>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <div class="fix_box">
        <!-- <div class="j_item">
            <div class="j_item_title">登记台</div>
            <div class="j_item_number">1</div>
        </div>
        <div class="j_item">
            <div class="j_item_title">登记台</div>
            <div class="j_item_number">2</div>
        </div> -->
    </div>
    <div id="black"></div>
    <script>
        var ChildId = '';
        var WritingDesk = '';
        var VaccinationId={$info.registerInfo.Id};

        var inputChildId = $('input[name="ChildId"]');
        var inputCardNo = $('input[name="CardNo"]');
        var inputMobile = $('input[name="Mobile"]');
        var inputName = $('input[name="Name"]');
        var inputBirthDate = $('input[name="BirthDate"]');
        var inputParentName = $('input[name="ParentName"]');
        var textareaAddress = $('textarea[name="Address"]');
        var selectSex = $('select[name="Sex"] option:selected');
        
        layui.use(['jquery', 'layer','table','laydate'], function(){
            var table = layui.table,
            layer = layui.layer,
            laydate= layui.laydate,
            $ = layui.jquery;

            // 显示接种台
            $(document).ready(function () {
                $("#black").css('display', "block");
                $(".fix_box").css('display', "block");
                var a = {$info.writingdeskcount};
                // a = 登记台个数
                var num = a * 210 / 2;
                var j_html = '';
                for ( i = 0; i < a; i++) {
                    // console.log(i)
                    j_html += '<div class="j_item" data='+ (i+1) +'><div class="j_item_title">登记台</div><div class="j_item_number">'+ (i+1) +'</div></div>';
                }
                $('.fix_box').html(j_html);
                $(".fix_box").css('left', 'calc(50% - ' + num + 'px)')
            });
            
            // 选中接种台
            $('.j_item').on('click',function(e){
    
                WritingDesk = e.currentTarget.attributes.data.value;
                // console.log(WritingDesk)
                $('input[name="WritingDesk"]').val(WritingDesk);
                $('.fix_box').hide();
                $('#black').hide();
                $('.un_number').show();
                $('.un_writingdesk').text('登记台'+WritingDesk);
                $('.un_writingdesk').show();

            });
            

            table.render({
                elem: '#test1'
                ,url:'{:url("childvaccines/getChildvaccines")}'
                ,cellMinWidth: 80 //全局定义常规单元格的最小宽度
                ,where:{
                    ChildId:ChildId
                }
                ,cols: [[
                    {field:'FullName', title: '接种疫苗', }
                    ,{field:'Times', title: '剂次'} 
                    ,{field:'LotNumber', title: '疫苗批号',  }
                    ,{field:'Company', title: '生产企业'}
                    ,{field:'VaccinationPosition', title: '接种部位'}
                    ,{field:'VaccinationPlace', title: '接种地址', align: 'center'} 
                    ,{title: '免费',   align: 'center',templet:function(d){
                        if(d.IsFree == 0){
                            return '不免费';
                        }else{
                            return '免费'
                        }

                    }} 
                ]],
                parseData: function(res){ //将原始数据解析成 table 组件所规定的数据
                    return {
                        'code':0,
                        'count':res.length,
                        'data': res
                    };
                },
            });

            
            // 日期
            laydate.render({
                elem: '.BirthDate',
                format: 'yyyy-MM-dd HH:mm:ss' //可任意组合
            });


            // 添加 tr
            $('.add_vaccination').on('click',function(){

                html = '<tr><td style="display: none;"><input type="hidden" name="Id" value="0"></td><td><select class="layui-input un-select" name="VaccineId"><option>请选择</option>{volist name="info.vaccines" id="vo"}<option value="{$vo.Id}">{$vo.ShortName}</option>{/volist}</select></td><td><input class="layui-input" type="text" name="Times" value="1"></td><td><input class="layui-input" type="text" placeholder="请填写疫苗批号" name="LotNumber"></td><td><input class="layui-input" type="text" placeholder="请填写疫苗公司" name="Company"></td><td><input class="layui-input" type="text" placeholder="请填写疫苗地址" name="VaccinationPlace"></td><td><input class="layui-input" type="text" placeholder="请填写接种部位" name="VaccinationPosition"></td><td><input type="checkbox" lay-skin="primary" name="IsFree" value="1"></td><td><a class="del_vaccination" id="0">删除</a></td></tr>';

                $('#test').find('tbody').append(html);
                
            });


            // 删除tr
            $(document).on('click','.del_vaccination',function(){

                var Id = $(this).attr('id');
                // console.log(Id)
                if(Id !== 0){
                    $.get('{:url("vaccinationdetails/delVaccinationDetail")}',{Id:Id});
                }
                $(this).parent().parent().remove();
            });

            // 点击下一个按钮
            $('.next_number').on('click',function(){
                var next = {$info.next};

                if(next == '' || next == null){
                    layer.msg('已经到最后一位啦!');
                }else{
                    window.location.href = "{:url()}?Id="+next;

                }

            });

            // 点击上一个按钮
            $('.prev_number').on('click',function(){
                var prev = {$info.prev};

                if(prev == '' || prev == null){
                    layer.msg('已经到第一位啦!');
                }else{
                    window.location.href = "{:url()}?Id="+prev;
                }

            });


            // 点击完成按钮
            $('.submit').on('click',function(){
                $('.fakeloader').show();
                // 孩子信息
                var child_id = inputChildId.val();
                var CardNo = inputCardNo.val();
                var Name = inputName.val();
                var BirthDate = inputBirthDate.val();
                var ParentName = inputParentName.val();
                var Mobile = inputMobile.val();
                var Sex = selectSex.val();
                var Address = textareaAddress.val();

                var childInfo = {
                    Id:child_id,
                    CardNo:CardNo,
                    Name:Name,
                    BirthDate:BirthDate,
                    ParentName:ParentName,
                    Mobile:Mobile,
                    Sex:Sex,
                    Address:Address,
                };

                $.post('{:url("childs/addChildInfo")}',childInfo,function(res){

                    if(res.code == 400){
                        $('.fakeloader').hide();
                        layer.msg(res.msg);
                    }else{
                        var dataInfo = {
                            Id:VaccinationId,
                            ChildId:res.childId,
                            WritingDesk:WritingDesk,
                        };
                        $.post('{:url("vaccinations/setVaccinationsInfo")}',dataInfo,function(ress){
                            // console.log(ress)
                            if(ress.code == 200){
                                
                                vacccineTbody = $('#test').find('tbody');

                                var trNum = vacccineTbody.children('tr').length;
                                
                                var vaccinesDate = {};

                                vaccinesDate.vaccineDate = [];

                                vaccinesDate.VaccinationId = VaccinationId;

                                var vDate = {};

                                for ( i = 0; i < trNum; i++) {
                                    data = {};

                                    data.Id = vacccineTbody.find('tr:eq('+i+')').find('input[name="Id"]').val();
                                    
                                    data.VaccineId = vacccineTbody.find('tr:eq('+i+')').find('select[name="VaccineId"] option:selected').val();
                                    data.Times = vacccineTbody.find('tr:eq('+i+')').find('input[name="Times"]').val();
                                    data.LotNumber = vacccineTbody.find('tr:eq('+i+')').find('input[name="LotNumber"]').val();
                                    data.Company = vacccineTbody.find('tr:eq('+i+')').find('input[name="Company"]').val();
                                    data.VaccinationPosition = vacccineTbody.find('tr:eq('+i+')').find('input[name="VaccinationPosition"]').val();
                                    data.VaccinationPlace = vacccineTbody.find('tr:eq('+i+')').find('input[name="VaccinationPlace"]').val();
                                    if($(vacccineTbody.find('tr:eq('+i+')').find('input[name="IsFree"]')).is(':checked')) {
                                        data.IsFree = 1;
                                    }else{
                                        data.IsFree = 0;
                                    }
                                    vDate[i] = data;
                                    
                                }
                                vaccinesDate.vaccineDate = vDate;

                                // console.log(vaccinesDate)

                                $.post('{:url("vaccinationdetails/setVaccinationDetail")}',vaccinesDate,function(resss){
                                    if(resss.code==200){
                                        $('.fakeloader').hide();
                                        layer.msg(resss.msg);
                                    }else{
                                        $('.fakeloader').hide();
                                        layer.msg(resss.msg)
                                    }
                                })

                            }else{
                                layer.msg(ress.msg);
                            }

                        })


                    }
                })
                

            });

            // 点击完成并下一位按钮
            $('.submit_next').on('click',function(){
                layer.msg('完成并下一位')
            });

            /**
            * 呼叫
            */
            $('.call_number').on('click',function(){
                var number = '{$info.registerInfo.Number}';

                $.post('{:url("Vaccinations/callNumber")}',{number:number,WritingDesk:WritingDesk},function(res){
                    // console.log(res);
                    if(res.code == 200){
                        layer.msg(res.msg,{icon:1});
                    }else{
                        layer.msg(res.msg,{icon:2});
                    }
                });
            });


            // 卡号的输入框失去焦点
            // $("input[name='CardNo']").blur(function(){
            //     getChildInfo();
            // });
            // 点击卡号里的搜索按钮
            $('.i-seach').on('click',function(e){
                getChildInfo();
            });

            // 点击搜索框 获取 卡号的输入框失去焦点市  进行查询孩子信息
            function getChildInfo(){
                // 卡号
                CardNo = inputCardNo.val();
                // 没填写卡号不请求数据
                if(CardNo == null || CardNo == ''){
                    layer.msg('请填写卡号');
                    return false;
                }

                $.post('{:url("childs/cardNoGetInfo")}',{CardNo:CardNo},function(res){
                    if(res.code == 0){
                        layer.msg('暂无该卡号信息，请先填写孩子信息');

                    }else{
                        
                        inputChildId.val(res.Id);
                        
                        inputMobile.val(res.Mobile);
                        inputParentName.val(res.ParentName);
                        inputName.val(res.Name);
                        var str = res.BirthDate;
                        var m =str.length;
                        var n = str.indexOf(' ');
                        var j = str.substring(n,m);
                        var BirthDate = str.replace(j,'');
                        inputBirthDate.val(BirthDate);
                        textareaAddress.val(res.Address);
                        // $('input[name="Sex"]').val(res.Sex);
                        if(res.Sex === 1){
                            $('select[name="Sex"]').find('option[value="1"]').attr('selected',"true");
                        }else if(res.Sex === 2){
                            $('select[name="Sex"]').find('option[value="2"]').attr('selected',"true");
                        }
                        layui.form.render();
                    }

                },'json');

                ChildId = inputChildId.val();

                table.reload('test1', {
                    url: '{:url("childvaccines/getChildvaccines")}'
                    ,where: {
                        ChildId:ChildId
                    }

                });
            }

        });


    </script>
